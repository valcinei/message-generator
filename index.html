<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Gerador de mensagens personalizadas para WhatsApp - Crie templates din√¢micos com vari√°veis customiz√°veis">
  <meta name="keywords" content="whatsapp, mensagens, gerador, templates, marketing, campanhas">
  <meta name="theme-color" content="#0f172a">
  <meta name="color-scheme" content="dark light">
  <title>Gerador de Mensagens Personalizadas ‚Ä¢ WhatsApp</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- Custom autocomplete styling -->

  
  <style>
    /* Estilos base responsivos */
    * {
      -webkit-tap-highlight-color: transparent;
      box-sizing: border-box;
    }
    
    html {
      touch-action: manipulation; /* Melhora performance em touch */
    }
    
    /* Scrollbars customizadas para mobile */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 4px;
      opacity: 0.7;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      opacity: 1;
    }

    /* Vari√°veis CSS para temas */
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --accent-2:#16a34a; --red:#ef4444; --blue:#3b82f6;
      --border:#1f2937; --input-bg:#0b1220; --input-border:#243244;
      /* Cores espec√≠ficas para melhor contraste */
      --text-primary:#f8fafc; --text-secondary:#cbd5e1; --text-muted:#94a3b8;
      --success:#10b981; --warning:#f59e0b; --info:#3b82f6;
      /* Vari√°veis adicionais para autocomplete */
      --bg-secondary:#1e293b;
    }
    
    [data-theme="light"] {
      --bg:#ffffff; --panel:#f8f9fa; --muted:#6c757d; --text:#212529; --accent:#198754; --accent-2:#157347; --red:#dc3545; --blue:#0d6efd;
      --border:#dee2e6; --input-bg:#ffffff; --input-border:#ced4da;
      /* Cores espec√≠ficas para tema claro */
      --text-primary:#1f2937; --text-secondary:#374151; --text-muted:#6b7280;
      --success:#059669; --warning:#d97706; --info:#2563eb;
      /* Vari√°veis adicionais para autocomplete */
      --bg-secondary:#f1f5f9;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; background:var(--bg); color:var(--text-primary); transition: all 0.3s ease;}
    .container-fluid{max-width:1200px;margin:0 auto;padding:32px 16px}
    h1{font-size:clamp(20px,3vw,28px);margin:0 0 16px; color:var(--text-primary);}
    h2{font-size:18px;margin:0 0 12px; color:var(--text-primary);}
    p.lead{color:var(--text-secondary);margin:0 0 20px}
    
    /* Cards customizados */
    .custom-card{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.1); margin-bottom:16px; transition: all 0.3s ease;}
    [data-theme="dark"] .custom-card{box-shadow:0 10px 30px rgba(0,0,0,.25);}
    
    /* Inputs customizados - melhor contraste */
    .form-control, .form-select, textarea{background:var(--input-bg); color:var(--text-primary); border:1px solid var(--input-border); border-radius:10px;}
    .form-control:focus, .form-select:focus, textarea:focus{background:var(--input-bg); color:var(--text-primary); border-color:var(--accent); box-shadow:0 0 0 0.2rem rgba(34, 197, 94, 0.25);}
    .form-control::placeholder, textarea::placeholder{color:var(--text-muted);}
    
    /* Labels melhor contraste */
    .form-label{color:var(--text-secondary); font-weight: 500;}
    
    /* Bot√µes customizados */
    .btn-primary{background:var(--accent); border-color:var(--accent); color:#04210e; font-weight: 600;}
    .btn-primary:hover{background:var(--accent-2); border-color:var(--accent-2); color:#04210e;}
    .btn-outline-secondary{color:var(--text-primary); border-color:var(--border); background:var(--input-bg);}
    .btn-outline-secondary:hover{background:var(--border); color:var(--text-primary); border-color:var(--border);}
    .btn-danger{background:var(--red); color:#ffffff;}
    .btn-info{background:var(--blue); color:#ffffff;}
    .btn-success{background:var(--success); color:#ffffff;}
    
    /* Tema switcher melhorado */
    .theme-switcher{position:fixed; top:20px; right:20px; z-index:1050;}
    .theme-switcher .btn{border-color:var(--border); background:var(--panel); color:var(--text-primary);}
    .theme-switcher .btn:hover{background:var(--input-bg); border-color:var(--accent); color:var(--accent);}
    .theme-switcher .btn.following-system{border-color:var(--info); color:var(--info);}
    .theme-switcher .btn.following-system::after{content:''; position:absolute; top:-2px; right:-2px; width:6px; height:6px; background:var(--info); border-radius:50%; border:1px solid var(--panel);}
    
    /* Bootstrap overrides para melhor contraste */
    .btn-outline-primary{color:var(--accent); border-color:var(--accent);}
    .btn-outline-primary:hover{background:var(--accent); color:#04210e; border-color:var(--accent);}
    .btn-outline-danger{color:var(--red); border-color:var(--red);}
    .btn-outline-danger:hover{background:var(--red); color:#ffffff; border-color:var(--red);}
    
    /* Alert e feedback visual */
    .fw-semibold{color:var(--text-primary) !important;}
    .fw-bold{color:var(--text-primary) !important;}
    
    /* Fix para dropdown do Bootstrap no tema escuro */
    .dropdown-menu{background:var(--panel); border:1px solid var(--border);}
    .dropdown-item{color:var(--text-primary);}
    .dropdown-item:hover{background:var(--input-bg); color:var(--text-primary);}
    
    /* Melhorar contraste em elementos pequenos */
    .small, .form-text{color:var(--text-muted) !important;}
    
    /* Scrollbar personalizada para tema escuro */
    [data-theme="dark"] ::-webkit-scrollbar{width:8px;}
    [data-theme="dark"] ::-webkit-scrollbar-track{background:var(--input-bg);}
    [data-theme="dark"] ::-webkit-scrollbar-thumb{background:var(--border); border-radius:4px;}
    [data-theme="dark"] ::-webkit-scrollbar-thumb:hover{background:var(--text-muted);}
    
    /* Table customizada - melhor contraste */
    .table{color:var(--text-primary); --bs-table-bg:transparent;}
    .table th{color:var(--text-secondary); border-color:var(--border); font-weight: 600; background:var(--input-bg);}
    .table td{border-color:var(--border); color:var(--text-primary);}
    .table tbody tr:hover{background-color:var(--input-bg);}
    .table-light{--bs-table-bg:var(--input-bg); --bs-table-color:var(--text-primary);}
    
    /* Preview customizado */
    .preview{white-space:pre-wrap; background:var(--input-bg); border:1px solid var(--input-border); padding:10px; border-radius:10px; min-height:120px; color:var(--text-primary);}
    
    /* Template preview styling */
    .template-preview {
      background: var(--input-bg);
      border: 1px solid var(--accent);
      border-radius: 12px;
      padding: 15px;
      min-height: 80px;
      color: var(--text-primary);
      white-space: pre-wrap;
      font-family: inherit;
      font-size: 14px;
      line-height: 1.5;
      position: relative;
    }
    
    .template-preview::before {
      content: '';
      position: absolute;
      top: -1px;
      left: -1px;
      right: -1px;
      bottom: -1px;
      background: linear-gradient(45deg, var(--accent), var(--accent-2));
      border-radius: 12px;
      z-index: -1;
      opacity: 0.1;
    }
    
    /* Variable highlighting in preview */
    .preview-variable {
      background: var(--accent);
      color: #04210e;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
      display: inline-block;
      margin: 0 1px;
    }
    
    .preview-invalid-variable {
      background: var(--red);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
      display: inline-block;
      margin: 0 1px;
      text-decoration: line-through;
    }
    
    /* Template textarea highlighting overlay */
    .template-highlight-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 1;
      font-family: inherit;
      font-size: inherit;
      line-height: inherit;
      padding: inherit;
      border: 1px solid transparent;
      overflow: hidden;
      white-space: pre-wrap;
      word-wrap: break-word;
      color: transparent;
      background: transparent;
    }
    
    .template-input-container {
      position: relative;
    }
    
    .template-input-container textarea {
      position: relative;
      z-index: 2;
      background: transparent;
      color: var(--text-primary);
    }
    
    .template-input-container .template-highlight-overlay {
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 10px;
      padding: 12px;
    }
    
    .highlight-variable {
      background: rgba(34, 197, 94, 0.3);
      color: transparent;
      border-radius: 3px;
      padding: 0 2px;
    }
    
    .highlight-invalid {
      background: rgba(239, 68, 68, 0.3);
      color: transparent;
      border-radius: 3px;
      padding: 0 2px;
    }
    
    /* Vari√°veis din√¢micas */
    .variable-item{background:var(--input-bg); border:1px solid var(--input-border); border-radius:8px; padding:12px; margin-bottom:8px}
    .variable-name{font-weight:600; color:var(--text-primary)}
    
    /* Badges melhor contraste */
    .badge{color:#ffffff;}
    .bg-secondary{background-color:var(--text-muted) !important;}
    
    /* Text utilities com melhor contraste */
    .text-muted{color:var(--text-muted) !important;}
    .text-success{color:var(--success) !important;}
    .text-danger{color:var(--red) !important;}
    .small{color:var(--text-muted);}
    
    /* Configura√ß√µes salvas - mais discretas */
    .config-summary{cursor:pointer; padding:8px 12px; background:var(--input-bg); border:1px solid var(--input-border); border-radius:6px; font-size:14px; display:flex; align-items:center; gap:8px; color:var(--text-primary);}
    .config-summary:hover{background:var(--border); color:var(--text-primary);}
    .config-summary i{color:var(--accent);}
    .config-dropdown{display:none; position:absolute; top:100%; left:0; right:0; background:var(--panel); border:1px solid var(--border); border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:1000; max-height:300px; overflow-y:auto;}
    [data-theme="dark"] .config-dropdown{box-shadow:0 4px 12px rgba(0,0,0,0.35);}
    .config-dropdown.show{display:block;}
    .config-item{padding:8px 12px; border-bottom:1px solid var(--border); cursor:pointer; color:var(--text-primary);}
    .config-item:hover{background:var(--input-bg);}
    .config-item:last-child{border-bottom:none;}
    
    /* Auto-save indicator */
    .autosave-indicator{position:fixed; bottom:20px; right:20px; background:var(--accent); color:#04210e; padding:8px 12px; border-radius:6px; font-size:12px; opacity:0; transition:opacity 0.3s; z-index:1000; font-weight: 600;}
    .autosave-indicator.show{opacity:1}
    
    /* Lista de mensagens */
    .message-item{border:1px solid var(--border); border-radius:12px; padding:12px; background:var(--input-bg); margin-bottom:12px}
    .message-item h6{color:var(--text-primary);}
    
    /* Code elements */
    code{background:var(--input-bg); color:var(--accent); padding:2px 4px; border-radius:4px; font-size:0.9em;}
    
    /* M√°scara de telefone */
    .phone-input{font-family:ui-monospace,'SF Mono',Monaco,'Cascadia Code','Roboto Mono',Consolas,'Liberation Mono','Menlo',monospace; letter-spacing:0.5px;}
    .phone-input::placeholder{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; letter-spacing:normal;}
    
    /* Responsividade adicional */
    @media(max-width:768px){
      .container-fluid{padding:16px 12px}
      .theme-switcher{top:10px; right:10px; z-index: 1001;}
      .config-dropdown{position:fixed; top:auto; bottom:0; left:0; right:0; max-height:50vh; border-radius:12px 12px 0 0; z-index: 1002;}
      
      /* Melhorar inputs em mobile */
      .form-control, textarea {
        font-size: 16px !important; /* Evita zoom no iOS */
        padding: 12px 16px;
        border-radius: 8px;
      }
      
      /* Bot√µes maiores para touch */
      .btn {
        padding: 12px 20px;
        font-size: 16px;
        min-height: 48px;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }
      
      /* Cards mais espa√ßados */
      .card {
        margin-bottom: 20px;
      }
      
      /* Preview responsivo */
      .template-preview {
        font-size: 14px;
        padding: 16px;
        max-height: 40vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      /* Tabelas responsivas */
      .table-responsive {
        font-size: 14px;
      }
      
      /* Melhor espa√ßamento para listas */
      .list-group-item {
        padding: 16px;
        font-size: 16px;
      }
    }

    /* Custom autocomplete menu customization */
    .custom-autocomplete-menu { 
      background: var(--panel); 
      color: var(--text-primary); 
      border: 2px solid var(--accent);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      overflow: hidden;
    }
    .autocomplete-item { 
      padding: 16px 20px; 
      transition: all 0.2s ease;
      border-bottom: 1px solid var(--border);
      min-height: 60px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    .autocomplete-item:last-of-type {
      border-bottom: none;
    }
    .autocomplete-item.selected, .autocomplete-item:hover, .autocomplete-item:active { 
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%) !important;
      color: #ffffff !important;
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(46, 204, 113, 0.4);
      font-weight: 600 !important;
    }
    .autocomplete-item.selected *, .autocomplete-item:hover *, .autocomplete-item:active * {
      color: #ffffff !important;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    .autocomplete-item .small { 
      color: var(--text-muted); 
      font-family: 'Courier New', monospace;
    }
    
    /* Mobile responsivo */
    @media (max-width: 768px) {
      .custom-autocomplete-menu {
        min-width: min(300px, 90vw) !important;
        max-width: 95vw !important;
        max-height: min(300px, 50vh) !important;
        font-size: 16px; /* Evita zoom no iOS */
        position: absolute !important;
        z-index: 9999 !important;
        will-change: transform, opacity;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
      }
      .autocomplete-item {
        padding: 18px 22px !important;
        min-height: 70px !important;
        -webkit-tap-highlight-color: transparent !important;
        user-select: none;
        -webkit-user-select: none;
      }
      
      /* Prevenir zoom e scroll indesejado no mobile */
      body.autocomplete-active {
        overflow: hidden;
        position: fixed;
        width: 100%;
      }
      
      /* Template highlighting responsivo */
      .template-input-container textarea,
      .template-highlight-backdrop {
        font-size: 16px; /* Evita zoom no iOS */
        line-height: 1.5;
      }
      
      /* Melhorar responsividade da se√ß√£o de registros */
      .btn-group {
        width: 100%;
      }
      
      .btn-group .btn {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      /* Tabela mais compacta em mobile */
      .table-responsive .table {
        font-size: 14px;
      }
      
      .table-responsive .table th,
      .table-responsive .table td {
        padding: 8px 6px;
        vertical-align: middle;
      }
      
      /* Bot√µes mais acess√≠veis em mobile */
      .btn {
        min-height: 44px;
        font-size: 14px;
      }
      
      /* Input de telefone em mobile */
      input[type="tel"] {
        font-size: 16px !important;
      }
    }
  </style>
</head>
<body>
  <!-- Theme Switcher -->
  <div class="theme-switcher">
    <button class="btn btn-outline-secondary btn-sm" id="themeToggle" title="Alternar tema">
      <i class="bi bi-moon-fill" id="themeIcon"></i>
    </button>
  </div>

  <div class="container-fluid">
    <div class="text-center mb-4">
      <h1><i class="bi bi-whatsapp text-success me-2"></i>Gerador de Mensagens Personalizadas</h1>
      <p class="lead">Defina suas pr√≥prias vari√°veis, configure templates e gere links <strong>wa.me</strong> personalizados para qualquer tipo de campanha. <strong>üíæ Seus dados s√£o salvos automaticamente.</strong></p>
    </div>

    <div class="row">
      <!-- Configura√ß√µes / Template -->
      <div class="col-lg-8 mb-4">
        <div class="custom-card">
          <h2><i class="bi bi-gear me-2"></i>1) Configura√ß√µes da Mensagem</h2>
          
          <!-- Configura√ß√µes b√°sicas -->
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label class="form-label">Nome da campanha/empresa</label>
              <input id="nomeCampanha" type="text" class="form-control" placeholder="Ex.: Minha Empresa" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Campo telefone (obrigat√≥rio)</label>
              <select id="campoTelefone" class="form-select">
                <option value="telefone">telefone</option>
                <option value="whatsapp">whatsapp</option>
                <option value="celular">celular</option>
                <option value="phone">phone</option>
              </select>
            </div>
          </div>

          <!-- Gerenciamento de Vari√°veis -->
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <label class="form-label mb-0 fw-bold">Vari√°veis Personalizadas</label>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-info" id="btnAdicionarVariavel" data-bs-toggle="modal" data-bs-target="#modalAdicionarVariavel">
                  <i class="bi bi-plus-circle me-1"></i>Adicionar Vari√°vel
                </button>
                <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#modalGerenciarDados">
                  <i class="bi bi-database me-1"></i>Gerenciar
                </button>
              </div>
            </div>
            <div id="listaVariaveis" class="mb-2"></div>
            <small class="text-muted">Arraste para reordenar as vari√°veis. O campo telefone √© obrigat√≥rio e sempre inclu√≠do.</small>
          </div>

          <!-- Template da mensagem -->
          <div class="mb-3">
            <label class="form-label">Template de mensagem</label>
            <textarea id="template" class="form-control" rows="6" placeholder="Digite sua mensagem usando {{variavel}} para substitui√ß√µes..."></textarea>
            <small class="text-muted mt-1 d-block">Use <code>{{nome_da_variavel}}</code> para inserir valores. Vari√°veis dispon√≠veis ser√£o listadas automaticamente.</small>
            <div id="variaveisDisponiveis" class="mt-2 small text-muted"></div>
            
            <!-- Preview da mensagem -->
            <div class="mt-3">
              <label class="form-label small">üì± Preview da mensagem:</label>
              <div id="templatePreview" class="template-preview">
                <div class="text-muted small text-center p-3">Digite o template acima para ver a pr√©via aqui</div>
              </div>
            </div>
          </div>

          <!-- Bot√µes de a√ß√£o para template -->
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-outline-secondary" id="btnCarregarExemplo">
              <i class="bi bi-file-earmark-plus me-1"></i>Carregar exemplo
            </button>
            <button class="btn btn-outline-secondary" id="btnSalvarConfig">
              <i class="bi bi-bookmark me-1"></i>Salvar configura√ß√£o
            </button>
          </div>
        </div>
      </div>

      <!-- Configura√ß√µes Salvas - mais discretas -->
      <div class="col-lg-4 mb-4">
        <div class="custom-card">
          <div class="position-relative">
            <div class="config-summary" id="configSummary">
              <i class="bi bi-bookmarks"></i>
              <span>Configura√ß√µes Salvas</span>
              <span class="badge bg-secondary ms-auto" id="configCount">0</span>
            </div>
            <div class="config-dropdown" id="configDropdown">
              <div class="p-2 border-bottom">
                <div class="d-flex gap-2 mb-2">
                  <label for="backupFile" class="btn btn-sm btn-outline-secondary flex-fill">
                    <i class="bi bi-upload me-1"></i>Importar
                  </label>
                  <input id="backupFile" class="d-none" type="file" accept=".json"/>
                  <button class="btn btn-sm btn-outline-secondary flex-fill" onclick="exportarDados()">
                    <i class="bi bi-download me-1"></i>Exportar
                  </button>
                </div>
                <button class="btn btn-sm btn-outline-primary w-100" onclick="carregarDados()">
                  <i class="bi bi-arrow-clockwise me-1"></i>Restaurar Auto-save
                </button>
              </div>
              <div id="listaConfiguracoes"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Dados dos registros -->
    <div class="custom-card">
      <h2><i class="bi bi-table me-2"></i>2) Registros</h2>
      <p class="text-muted mb-3">Adicione os dados que ser√£o utilizados nas mensagens personalizadas.</p>
      
      <!-- Controles de dados -->
      <div class="row g-2 mb-3">
        <div class="col-12">
          <div class="d-flex flex-wrap gap-2 align-items-center">
            <!-- Adicionar registros -->
            <button class="btn btn-primary" id="btnNovaLinha">
              <i class="bi bi-plus-circle me-1"></i>Adicionar registro
            </button>
            
            <!-- Importar dados -->
            <div class="btn-group">
              <label for="csv" class="btn btn-outline-info">
                <i class="bi bi-file-earmark-csv me-1"></i>Importar CSV
              </label>
              <input id="csv" class="d-none" type="file" accept=".csv"/>
              <label for="jsonImport" class="btn btn-outline-info">
                <i class="bi bi-file-earmark-code me-1"></i>Importar JSON
              </label>
              <input id="jsonImport" class="d-none" type="file" accept=".json"/>
            </div>
            
            <!-- Gerenciar listas -->
            <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#modalGerenciarDados">
              <i class="bi bi-people me-1"></i>Gerenciar Listas
            </button>
            
            <!-- A√ß√µes destrutivas -->
            <button class="btn btn-outline-danger" id="btnLimpar">
              <i class="bi bi-trash me-1"></i>Limpar registros
            </button>
            
            <!-- Gerar mensagens -->
            <div class="ms-auto">
              <button class="btn btn-success btn-lg" id="btnGerar">
                <i class="bi bi-magic me-2"></i>Gerar Mensagens
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="table-responsive">
        <table class="table table-hover" id="tbl" aria-label="Tabela de registros">
          <thead class="table-light">
            <tr id="tableHeader"></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Lista de mensagens geradas -->
    <div class="custom-card">
      <h2><i class="bi bi-chat-dots me-2"></i>3) Mensagens e Links</h2>
      <p class="text-muted mb-3">Clique para abrir o WhatsApp com a mensagem. Use "Copiar" para enviar por outro canal.</p>
      <div id="lista"></div>
    </div>

    <footer class="text-center text-muted mt-4 pb-4">
      <small>
        <strong>Dicas:</strong> 
        ‚Ä¢ N√∫meros brasileiros podem ser digitados como <em>92 9 9999-9999</em> ‚Äî normalizamos automaticamente para formato internacional<br>
        ‚Ä¢ Use *texto* para negrito e _texto_ para it√°lico no WhatsApp<br>
        ‚Ä¢ Vari√°veis com valores monet√°rios s√£o formatadas automaticamente em BRL
      </small>
    </footer>
  </div>

  <!-- Indicador de auto-save -->
  <div id="autosaveIndicator" class="autosave-indicator">
    <i class="bi bi-cloud-check me-1"></i>Dados salvos automaticamente
  </div>

  <!-- Modal para adicionar vari√°vel -->
  <div class="modal fade" id="modalAdicionarVariavel" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content" style="background: var(--panel); color: var(--text-primary); border: 1px solid var(--border);">
        <div class="modal-header" style="border-color: var(--border);">
          <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Adicionar Nova Vari√°vel</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: var(--bs-btn-close-white-filter);"></button>
        </div>
        <div class="modal-body">
          <form id="formVariavel">
            <div class="mb-3">
              <label for="nomeVariavel" class="form-label">Nome da vari√°vel</label>
              <input type="text" class="form-control" id="nomeVariavel" placeholder="Ex: produto, valor, data_entrega" required>
              <div class="form-text">Use apenas letras, n√∫meros e underscore. Sem espa√ßos.</div>
            </div>
            <div class="mb-3">
              <label for="labelVariavel" class="form-label">Label para exibi√ß√£o</label>
              <input type="text" class="form-control" id="labelVariavel" placeholder="Ex: Produto, Valor, Data de entrega" required>
            </div>
            <div class="mb-3">
              <label for="tipoVariavel" class="form-label">Tipo de campo</label>
              <select class="form-select" id="tipoVariavel">
                <option value="text">Texto</option>
                <option value="number">N√∫mero</option>
                <option value="date">Data</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer" style="border-color: var(--border);">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnConfirmarVariavel">Adicionar Vari√°vel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para salvar configura√ß√£o -->
  <div class="modal fade" id="modalSalvarConfig" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content" style="background: var(--panel); color: var(--text-primary); border: 1px solid var(--border);">
        <div class="modal-header" style="border-color: var(--border);">
          <h5 class="modal-title"><i class="bi bi-bookmark me-2"></i>Salvar Configura√ß√£o</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: var(--bs-btn-close-white-filter);"></button>
        </div>
        <div class="modal-body">
          <form id="formSalvarConfig">
            <div class="mb-3">
              <label for="nomeConfig" class="form-label">Nome da configura√ß√£o</label>
              <input type="text" class="form-control" id="nomeConfig" placeholder="Ex: Black Friday 2024, Campanha Natal" required>
              <div class="form-text">Escolha um nome descritivo para identificar esta configura√ß√£o.</div>
            </div>
          </form>
        </div>
        <div class="modal-footer" style="border-color: var(--border);">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnConfirmarSalvarConfig">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para confirmar a√ß√µes -->
  <div class="modal fade" id="modalConfirmar" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content" style="background: var(--panel); color: var(--text-primary); border: 1px solid var(--border);">
        <div class="modal-header" style="border-color: var(--border);">
          <h5 class="modal-title" id="modalConfirmarTitulo">Confirmar A√ß√£o</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: var(--bs-btn-close-white-filter);"></button>
        </div>
        <div class="modal-body">
          <p id="modalConfirmarTexto"></p>
        </div>
        <div class="modal-footer" style="border-color: var(--border);">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="btnConfirmarAcao">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para gerenciar dados salvos -->
  <div class="modal fade" id="modalGerenciarDados" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" style="background: var(--panel); color: var(--text-primary); border: 1px solid var(--border);">
        <div class="modal-header" style="border-color: var(--border);">
          <h5 class="modal-title"><i class="bi bi-database me-2"></i>Gerenciar Dados Salvos</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: var(--bs-btn-close-white-filter);"></button>
        </div>
        <div class="modal-body">
          <ul class="nav nav-tabs mb-3" id="tabsDados" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="tab-clientes" data-bs-toggle="tab" data-bs-target="#pane-clientes" type="button" role="tab">
                <i class="bi bi-people me-1"></i>Listas de Registros
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-configs" data-bs-toggle="tab" data-bs-target="#pane-configs" type="button" role="tab">
                <i class="bi bi-gear me-1"></i>Configura√ß√µes Completas
              </button>
            </li>
          </ul>
          
          <div class="tab-content" id="tabsContent">
            <!-- Tab Registros/Clientes -->
            <div class="tab-pane fade show active" id="pane-clientes" role="tabpanel">
              <div class="alert alert-info d-flex align-items-center mb-3">
                <i class="bi bi-info-circle me-2"></i>
                <div>
                  <strong>Listas de Registros:</strong> Salvam apenas os dados dos registros (tabela) e as vari√°veis configuradas. 
                  √ötil para reutilizar diferentes grupos de clientes/produtos.
                </div>
              </div>
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">Suas Listas Salvas</h6>
                <button class="btn btn-sm btn-primary" id="btnSalvarClientes">
                  <i class="bi bi-floppy me-1"></i>Salvar Lista Atual
                </button>
              </div>
              <div id="listaClientesSalvos"></div>
            </div>
            
            <!-- Tab Configura√ß√µes -->
            <div class="tab-pane fade" id="pane-configs" role="tabpanel">
              <div class="alert alert-warning d-flex align-items-center mb-3">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <div>
                  <strong>Configura√ß√µes Completas:</strong> Salvam tudo (template, vari√°veis, registros, nome da campanha). 
                  √ötil para salvar campanhas completas para reutilizar depois.
                </div>
              </div>
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">Configura√ß√µes Salvas</h6>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-secondary" onclick="exportarDados()">
                    <i class="bi bi-download me-1"></i>Exportar Tudo
                  </button>
                  <label for="importarTudo" class="btn btn-outline-secondary">
                    <i class="bi bi-upload me-1"></i>Importar
                  </label>
                  <input id="importarTudo" type="file" accept=".json" class="d-none">
                </div>
              </div>
              <div id="listaConfigsSalvas"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer" style="border-color: var(--border);">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


  <script>
    // Estado da aplica√ß√£o
    const state = {
      variaveis: [
        { nome: 'nome', label: 'Nome completo', tipo: 'text', obrigatorio: true },
        { nome: 'telefone', label: 'Telefone', tipo: 'text', obrigatorio: true }
      ],
      registros: []
    };

    // Utilidades
    const el = (sel, ctx=document) => ctx.querySelector(sel);
    const els = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

    // ===== Theme Management =====
    function initTheme() {
      const savedTheme = localStorage.getItem('app-theme');
      
      if (savedTheme) {
        // Se o usu√°rio j√° escolheu um tema, usar esse
        setTheme(savedTheme);
      } else {
        // Detectar tema do sistema automaticamente
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const systemTheme = systemPrefersDark ? 'dark' : 'light';
        setTheme(systemTheme);
        
        // Escutar mudan√ßas no tema do sistema
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
          // S√≥ mudar automaticamente se o usu√°rio n√£o escolheu um tema espec√≠fico
          if (!localStorage.getItem('app-theme')) {
            const newSystemTheme = e.matches ? 'dark' : 'light';
            setTheme(newSystemTheme, false); // false = n√£o salvar no localStorage
          }
        });
      }
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      setTheme(newTheme, true); // true = salvar escolha do usu√°rio
    }

    function setTheme(theme, savePreference = true) {
      document.documentElement.setAttribute('data-theme', theme);
      
      if (savePreference) {
        localStorage.setItem('app-theme', theme);
      }
      
      const icon = el('#themeIcon');
      const btn = el('#themeToggle');
      
      if (theme === 'light') {
        icon.className = 'bi bi-sun-fill';
        btn.title = savePreference ? 'Mudar para tema escuro' : 'Tema claro (autom√°tico)';
      } else {
        icon.className = 'bi bi-moon-fill';
        btn.title = savePreference ? 'Mudar para tema claro' : 'Tema escuro (autom√°tico)';
      }
      
      // Adicionar indicador visual se est√° seguindo o sistema
      if (!savePreference) {
        btn.classList.add('following-system');
      } else {
        btn.classList.remove('following-system');
      }
      
      // Atualizar cor do tema no meta tag se existir
      updateThemeColor(theme);
    }

    function updateThemeColor(theme) {
      // Adicionar meta theme-color para mobile
      let metaThemeColor = document.querySelector('meta[name="theme-color"]');
      if (!metaThemeColor) {
        metaThemeColor = document.createElement('meta');
        metaThemeColor.name = 'theme-color';
        document.head.appendChild(metaThemeColor);
      }
      
      const colors = {
        dark: '#0f172a',
        light: '#ffffff'
      };
      
      metaThemeColor.content = colors[theme];
    }

    // ===== Configura√ß√µes salvas discretas =====
    function initConfigDropdown() {
      const summary = el('#configSummary');
      const dropdown = el('#configDropdown');
      
      summary.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.toggle('show');
      });

      // Fechar ao clicar fora
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.config-summary') && !e.target.closest('.config-dropdown')) {
          dropdown.classList.remove('show');
        }
      });
    }

    function updateConfigCount() {
      const savedConfigs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      const count = Object.keys(savedConfigs).length;
      el('#configCount').textContent = count;
    }

    // ===== LocalStorage Management =====
    const STORAGE_KEY = 'message-generator-data';
    const AUTOSAVE_KEY = 'message-generator-autosave';

    function salvarDados(nome = null) {
      const dados = {
        nomeCampanha: el('#nomeCampanha').value.trim(),
        campoTelefone: el('#campoTelefone').value,
        template: el('#template').value.trim(),
        variaveis: state.variaveis,
        registros: lerTabela(),
        timestamp: new Date().toISOString()
      };

      if (nome) {
        const savedConfigs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        savedConfigs[nome] = dados;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(savedConfigs));
        mostrarAlerta('Sucesso', `Configura√ß√£o "${nome}" salva com sucesso!`, 'success');
        atualizarListaConfiguracoes();
      } else {
        localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(dados));
        mostrarIndicadorAutoSave();
      }
    }

    function mostrarIndicadorAutoSave() {
      const indicator = el('#autosaveIndicator');
      indicator.classList.add('show');
      setTimeout(() => indicator.classList.remove('show'), 2000);
    }

    function carregarDados(nome = null) {
      let dados;
      
      if (nome) {
        const savedConfigs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        dados = savedConfigs[nome];
        if (!dados) {
          mostrarAlerta('Erro', `Configura√ß√£o "${nome}" n√£o encontrada.`, 'danger');
          return;
        }
      } else {
        dados = JSON.parse(localStorage.getItem(AUTOSAVE_KEY) || 'null');
        if (!dados) return;
      }

      el('#nomeCampanha').value = dados.nomeCampanha || '';
      el('#campoTelefone').value = dados.campoTelefone || 'telefone';
      el('#template').value = dados.template || '';
      
      if (dados.variaveis) {
        state.variaveis = dados.variaveis;
        renderizarVariaveis();
        renderizarTabela();
      }
      
      if (dados.registros && dados.registros.length > 0) {
        els('#tbl tbody tr').forEach(tr => tr.remove());
        dados.registros.forEach(addRow);
      } else {
        addRow({});
      }

      atualizarVariaveisDisponiveis();
      
      // Aplicar m√°scaras ap√≥s carregar dados
      setTimeout(() => {
        aplicarMascarasEmTodosOsTelefones();
        // Atualizar preview ap√≥s carregar dados
        updateTemplatePreview();
      }, 100);
      
      if (nome) mostrarAlerta('Sucesso', `Configura√ß√£o "${nome}" carregada com sucesso!`, 'success');
    }

    function excluirConfiguracao(nome) {
      mostrarModalConfirmacao('Excluir Configura√ß√£o', `Tem certeza que deseja excluir a configura√ß√£o "${nome}"?`, () => {
        const savedConfigs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        delete savedConfigs[nome];
        localStorage.setItem(STORAGE_KEY, JSON.stringify(savedConfigs));
        mostrarAlerta('Sucesso', `Configura√ß√£o "${nome}" exclu√≠da!`, 'success');
        atualizarListaConfiguracoes();
      });
    }

    function atualizarListaConfiguracoes() {
      const savedConfigs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      const lista = el('#listaConfiguracoes');
      lista.innerHTML = '';

      const nomes = Object.keys(savedConfigs).sort();
      if (nomes.length === 0) {
        lista.innerHTML = '<div class="p-3 text-center text-muted small">Nenhuma configura√ß√£o salva</div>';
        updateConfigCount();
        return;
      }

      nomes.forEach(nome => {
        const config = savedConfigs[nome];
        const item = document.createElement('div');
        item.className = 'config-item';
        item.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <div class="fw-semibold">${nome}</div>
              <div class="small text-muted">${config.nomeCampanha || 'Sem nome'} ‚Ä¢ ${config.registros?.length || 0} registros</div>
              <div class="small text-muted">${new Date(config.timestamp).toLocaleDateString('pt-BR')}</div>
            </div>
            <div class="d-flex gap-1">
              <button class="btn btn-sm btn-outline-primary" onclick="carregarDados('${nome}')" title="Carregar">
                <i class="bi bi-arrow-down-circle"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="excluirConfiguracao('${nome}')" title="Excluir">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        `;
        lista.appendChild(item);
      });
      
      updateConfigCount();
      atualizarListaConfigsModal(); // Atualizar tamb√©m o modal
    }

    function atualizarListaConfigsModal() {
      const savedConfigs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      const container = el('#listaConfigsSalvas');
      if (!container) return;
      
      container.innerHTML = '';

      const nomes = Object.keys(savedConfigs).sort();
      if (nomes.length === 0) {
        container.innerHTML = '<div class="text-center text-muted p-3"><i class="bi bi-inbox"></i><br>Nenhuma configura√ß√£o completa salva ainda</div>';
        return;
      }

      nomes.forEach(nome => {
        const config = savedConfigs[nome];
        const div = document.createElement('div');
        div.className = 'border rounded p-3 mb-2';
        div.style.background = 'var(--input-bg)';
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="mb-1"><i class="bi bi-gear me-1"></i>${nome}</h6>
              <small class="text-muted">
                <i class="bi bi-building me-1"></i>${config.nomeCampanha || 'Sem nome'} ‚Ä¢ 
                <i class="bi bi-person me-1"></i>${config.registros?.length || 0} registros ‚Ä¢ 
                <i class="bi bi-tags me-1"></i>${config.variaveis?.length || 0} vari√°veis ‚Ä¢ 
                ${new Date(config.timestamp).toLocaleDateString('pt-BR')}
              </small>
            </div>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="carregarConfigCompleta('${nome}')" title="Carregar configura√ß√£o completa">
                <i class="bi bi-arrow-down-circle"></i>
              </button>
              <button class="btn btn-outline-danger" onclick="excluirConfiguracao('${nome}')" title="Excluir configura√ß√£o">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function carregarConfigCompleta(nome) {
      carregarDados(nome);
      // Fechar modal
      bootstrap.Modal.getInstance(el('#modalGerenciarDados')).hide();
    }

    function exportarDados() {
      const savedConfigs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      const autosave = JSON.parse(localStorage.getItem(AUTOSAVE_KEY) || 'null');
      
      const exportData = {
        configuracoes: savedConfigs,
        autosave: autosave,
        exportado_em: new Date().toISOString()
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `message-generator-backup-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importarDados(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          
          if (data.configuracoes) {
            const savedConfigs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            Object.assign(savedConfigs, data.configuracoes);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(savedConfigs));
          }
          
          if (data.autosave) {
            localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(data.autosave));
          }
          
          alert('Dados importados com sucesso!');
          atualizarListaConfiguracoes();
        } catch (e) {
          alert('Erro ao importar dados. Verifique se o arquivo est√° correto.');
        }
      };
      reader.readAsText(file, 'utf-8');
    }

    // ===== Gerenciamento de Vari√°veis =====
    function adicionarVariavel() {
      // Esta fun√ß√£o agora apenas abre o modal - o modal j√° est√° configurado no HTML
    }

    function confirmarAdicionarVariavel() {
      const nome = el('#nomeVariavel').value.trim();
      const label = el('#labelVariavel').value.trim();
      const tipo = el('#tipoVariavel').value;

      if (!nome || !label) {
        mostrarAlerta('Erro', 'Por favor, preencha todos os campos obrigat√≥rios.', 'danger');
        return;
      }

      // Validar e limpar nome da vari√°vel
      const nomeVar = nome.toLowerCase().replace(/[^a-z0-9_]/g, '');
      if (!nomeVar || !/^[a-z_][a-z0-9_]*$/.test(nomeVar)) {
        mostrarAlerta('Erro', 'Nome da vari√°vel deve conter apenas letras, n√∫meros e underscore, come√ßando com letra ou underscore.', 'danger');
        return;
      }

      // Verificar se j√° existe
      if (state.variaveis.some(v => v.nome === nomeVar)) {
        mostrarAlerta('Erro', `A vari√°vel "${nomeVar}" j√° existe.`, 'danger');
        return;
      }

      // Adicionar vari√°vel
      state.variaveis.push({ 
        nome: nomeVar, 
        label: label.trim(), 
        tipo: tipo, 
        obrigatorio: false 
      });
      
      renderizarVariaveis();
      renderizarTabela();
      atualizarVariaveisDisponiveis();
      salvarDados();

      // Limpar form e fechar modal
      el('#formVariavel').reset();
      bootstrap.Modal.getInstance(el('#modalAdicionarVariavel')).hide();
      
      mostrarAlerta('Sucesso', `Vari√°vel "${label}" adicionada com sucesso!`, 'success');
    }

    function removerVariavel(index) {
      const variavel = state.variaveis[index];
      if (variavel.obrigatorio) {
        mostrarAlerta('Erro', 'N√£o √© poss√≠vel remover vari√°veis obrigat√≥rias.', 'warning');
        return;
      }

      mostrarModalConfirmacao(
        'Remover Vari√°vel', 
        `Tem certeza que deseja remover a vari√°vel "${variavel.label}"?`, 
        () => {
          state.variaveis.splice(index, 1);
          renderizarVariaveis();
          renderizarTabela();
          atualizarVariaveisDisponiveis();
          salvarDados();
          mostrarAlerta('Sucesso', `Vari√°vel "${variavel.label}" removida!`, 'success');
        }
      );
    }

    function renderizarVariaveis() {
      const container = el('#listaVariaveis');
      container.innerHTML = '';

      state.variaveis.forEach((variavel, index) => {
        const item = document.createElement('div');
        item.className = 'variable-item d-flex justify-content-between align-items-start';
        item.innerHTML = `
          <div class="flex-grow-1">
            <div class="variable-name">${variavel.label}</div>
            <div class="small text-muted">{{${variavel.nome}}} ‚Ä¢ ${variavel.tipo}${variavel.obrigatorio ? ' ‚Ä¢ obrigat√≥rio' : ''}</div>
          </div>
          <div>
            ${!variavel.obrigatorio ? 
              `<button class="btn btn-sm btn-outline-danger" onclick="removerVariavel(${index})">
                <i class="bi bi-trash"></i>
              </button>` : 
              '<span class="badge bg-secondary">Obrigat√≥rio</span>'
            }
          </div>
        `;
        container.appendChild(item);
      });
        // Agora usando autocomplete customizado
    }

    function atualizarVariaveisDisponiveis() {
      const container = el('#variaveisDisponiveis');
      const variaveis = state.variaveis.map(v => `<code>{{${v.nome}}}</code>`).join(', ');
      container.innerHTML = `<strong>Vari√°veis dispon√≠veis:</strong> ${variaveis}`;
      
      // Atualizar preview quando vari√°veis mudam
      updateTemplatePreview();
      
      // Atualizar highlighting quando vari√°veis mudam
      const overlay = el('#templateHighlightOverlay');
      if (overlay) {
        const templateTextarea = el('#template');
        if (templateTextarea) {
          const highlightedText = highlightVariablesInText(templateTextarea.value);
          overlay.innerHTML = highlightedText;
        }
      }
    }

    // ===== Autocomplete para vari√°veis =====
    let customAutocompleteActive = false;
    let debounceTimer = null;
    
    function initVariableAutocomplete() {
      setupCustomAutocomplete();
    }

    function setupCustomAutocomplete() {
      const textarea = el('#template');
      if (!textarea) return;

      let autocompleteContainer = null;
      let currentSuggestions = [];
      let selectedIndex = -1;

      function showAutocomplete(suggestions, cursorPos) {
        hideAutocomplete();
        
        if (suggestions.length === 0) return;
        
        autocompleteContainer = document.createElement('div');
        autocompleteContainer.className = 'custom-autocomplete-menu';
        autocompleteContainer.style.cssText = `
          position: absolute;
          background: var(--panel);
          border: 2px solid var(--accent);
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.1);
          backdrop-filter: blur(10px);
          z-index: 10001;
          max-height: min(250px, 40vh);
          overflow-y: auto;
          min-width: min(280px, 90vw);
          max-width: min(400px, 95vw);
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          opacity: 0;
          transform: translateY(-10px) scale(0.95);
          transition: all 0.2s ease;
          -webkit-overflow-scrolling: touch;
          overscroll-behavior: contain;
          will-change: transform, opacity;
          backface-visibility: hidden;
          -webkit-backface-visibility: hidden;
        `;
        
        // Calcular posi√ß√£o baseada no cursor
        const textareaRect = textarea.getBoundingClientRect();
        const textBeforeCursor = textarea.value.substring(0, cursorPos);
        const lines = textBeforeCursor.split('\n');
        const currentLine = lines.length;
        const currentColumn = lines[lines.length - 1].length;
        
        // Aproxima√ß√£o da posi√ß√£o do cursor
        const charWidth = 8; // pixels por caractere aproximadamente
        const lineHeight = 24; // altura da linha aproximadamente
        
        // Posicionamento responsivo
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const isMobile = viewportWidth <= 768;
        
        let left, top;
        
        if (isMobile) {
          // Em mobile, posicionar de forma mais est√°vel
          const textareaTop = textareaRect.top + window.scrollY;
          const textareaBottom = textareaRect.bottom + window.scrollY;
          
          // Centralizar horizontalmente com margem
          left = Math.max(10, Math.min((viewportWidth - 300) / 2, viewportWidth - 310));
          
          // Posicionar preferencialmente abaixo do textarea
          top = textareaBottom + 10;
          
          // Se n√£o couber na parte inferior vis√≠vel da tela, posicionar acima
          if (top + 200 > window.scrollY + viewportHeight) {
            top = Math.max(window.scrollY + 10, textareaTop - 210);
          }
          
          // Garantir que n√£o saia da tela
          top = Math.max(window.scrollY + 10, Math.min(top, window.scrollY + viewportHeight - 220));
          
        } else {
          // Desktop: posi√ß√£o baseada no cursor
          left = textareaRect.left + (currentColumn * charWidth) + 10;
          top = textareaRect.top + (currentLine * lineHeight) + 25 + window.scrollY;
          
          // Ajustar se sair da tela
          left = Math.min(left, viewportWidth - 320);
          top = Math.min(top, window.scrollY + viewportHeight - 200);
        }
        
        autocompleteContainer.style.left = Math.max(10, left) + 'px';
        autocompleteContainer.style.top = Math.max(10, top) + 'px';
        autocompleteContainer.style.position = 'absolute';
        
        suggestions.forEach((suggestion, index) => {
          const item = document.createElement('div');
          item.className = 'autocomplete-item';
          item.style.cssText = `
            padding: 16px 20px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            touch-action: manipulation;
          `;
          
          // Mostrar diferentes formatos baseado no contexto
          const isInside = suggestion.isInsideVariable;
          const contextInfo = isInside ? 'Completar vari√°vel' : 'Inserir vari√°vel';
          const displayCode = isInside ? suggestion.key + '}}' : '{{' + suggestion.key + '}}';
          
          item.innerHTML = `
            <div style="font-weight: 600; color: var(--accent); font-size: 15px; margin-bottom: 6px; line-height: 1.2;">
              ${suggestion.label}
              <span style="font-size: 11px; color: var(--text-muted); font-weight: 400; margin-left: 8px;">${contextInfo}</span>
            </div>
            <div style="font-size: 13px; color: var(--text-muted); font-family: 'Courier New', monospace; background: rgba(255,255,255,0.05); padding: 4px 8px; border-radius: 6px; display: inline-block; line-height: 1.3;">${displayCode}</div>
          `;
          
          item.addEventListener('click', () => selectSuggestion(suggestion));
          item.addEventListener('touchend', (e) => {
            e.preventDefault();
            e.stopPropagation();
            selectSuggestion(suggestion);
          });
          item.addEventListener('mouseenter', () => {
            selectedIndex = index;
            updateSelection();
          });
          item.addEventListener('touchstart', (e) => {
            e.preventDefault();
            selectedIndex = index;
            updateSelection();
          });
          
          item.addEventListener('mouseleave', () => {
            // Adicionar efeito suave ao sair
            if (index !== selectedIndex) {
              item.style.transform = 'translateX(0)';
            }
          });
          
          autocompleteContainer.appendChild(item);
        });
        
        // Adicionar um rodap√© informativo
        if (suggestions.length > 0) {
          const footer = document.createElement('div');
          footer.style.cssText = `
            padding: 8px 16px;
            font-size: 11px;
            color: var(--text-muted);
            border-top: 1px solid var(--border);
            background: rgba(255,255,255,0.02);
            text-align: center;
          `;
          
          const hasInsideVariable = suggestions.some(s => s.isInsideVariable);
          const hasOutsideVariable = suggestions.some(s => !s.isInsideVariable);
          
          let footerText = '‚Üë‚Üì navegar ‚Ä¢ Enter selecionar ‚Ä¢ Esc fechar';
          if (hasInsideVariable && hasOutsideVariable) {
            footerText += ' ‚Ä¢ Completar {{}} ou inserir nova vari√°vel';
          } else if (hasInsideVariable) {
            footerText += ' ‚Ä¢ Completando vari√°vel dentro de {{}}';
          } else {
            footerText += ' ‚Ä¢ Inserindo nova vari√°vel';
          }
          
          footer.innerHTML = footerText;
          autocompleteContainer.appendChild(footer);
        }
        
        // Remover borda da √∫ltima op√ß√£o
        const lastItem = autocompleteContainer.querySelector('.autocomplete-item:last-of-type');
        if (lastItem) {
          lastItem.style.borderBottom = 'none';
        }
        
        document.body.appendChild(autocompleteContainer);
        currentSuggestions = suggestions;
        selectedIndex = 0;
        customAutocompleteActive = true;
        updateSelection();
        
        // Em mobile, apenas prevenir scroll do autocomplete, n√£o do body
        if (window.innerWidth <= 768) {
          autocompleteContainer.style.position = 'fixed';
          autocompleteContainer.style.zIndex = '10000';
        }
        
        // Animar entrada
        requestAnimationFrame(() => {
          autocompleteContainer.style.opacity = '1';
          autocompleteContainer.style.transform = 'translateY(0) scale(1)';
        });
      }

      function hideAutocomplete() {
        // Cancelar qualquer timer de debounce pendente
        if (debounceTimer) {
          clearTimeout(debounceTimer);
          debounceTimer = null;
        }
        
        if (autocompleteContainer) {
          autocompleteContainer.remove();
          autocompleteContainer = null;
          currentSuggestions = [];
          selectedIndex = -1;
          customAutocompleteActive = false;
        }
      }

      function updateSelection() {
        if (!autocompleteContainer) return;
        
        const items = autocompleteContainer.querySelectorAll('.autocomplete-item');
        items.forEach((item, index) => {
          if (index === selectedIndex) {
            item.style.background = 'linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)';
            item.style.color = '#ffffff';
            item.style.transform = 'translateX(4px)';
            item.style.boxShadow = '0 4px 12px rgba(46, 204, 113, 0.4)';
            item.style.fontWeight = '600';
            
            // Destacar o texto da vari√°vel selecionada com contraste alto
            const labelDiv = item.querySelector('div:first-child');
            const variableCode = item.querySelector('div:last-child');
            if (labelDiv) {
              labelDiv.style.color = '#ffffff';
              labelDiv.style.textShadow = '0 1px 2px rgba(0,0,0,0.3)';
            }
            if (variableCode) {
              variableCode.style.background = 'rgba(255,255,255,0.25)';
              variableCode.style.color = '#ffffff';
              variableCode.style.fontWeight = '700';
              variableCode.style.textShadow = '0 1px 2px rgba(0,0,0,0.3)';
            }
            
            // Scroll into view se necess√°rio
            item.scrollIntoView({ block: 'nearest' });
          } else {
            item.style.background = 'transparent';
            item.style.color = 'var(--text-primary)';
            item.style.transform = 'translateX(0)';
            item.style.boxShadow = 'none';
            item.style.fontWeight = '400';
            
            // Resetar estilo do c√≥digo da vari√°vel
            const labelDiv = item.querySelector('div:first-child');
            const variableCode = item.querySelector('div:last-child');
            if (labelDiv) {
              labelDiv.style.color = 'var(--accent)';
              labelDiv.style.textShadow = 'none';
            }
            if (variableCode) {
              variableCode.style.background = 'rgba(255,255,255,0.05)';
              variableCode.style.color = 'var(--text-muted)';
              variableCode.style.fontWeight = '400';
              variableCode.style.textShadow = 'none';
            }
          }
        });
      }

      function selectSuggestion(suggestion) {
        // Cancelar qualquer timer de debounce pendente
        if (debounceTimer) {
          clearTimeout(debounceTimer);
          debounceTimer = null;
        }
        
        const cursorPos = textarea.selectionStart;
        const text = textarea.value;
        
        // Usar as informa√ß√µes do contexto da sugest√£o
        const searchStart = suggestion.searchStart;
        const searchEnd = suggestion.searchEnd;
        const insertText = suggestion.insertText;
        
        if (searchStart >= 0) {
          // Substituir o texto de busca com a vari√°vel selecionada
          const before = text.substring(0, searchStart);
          const after = text.substring(searchEnd);
          const newText = before + insertText + after;
          
          textarea.value = newText;
          const newCursorPos = searchStart + insertText.length;
          textarea.setSelectionRange(newCursorPos, newCursorPos);
          
          // Disparar eventos
          textarea.dispatchEvent(new Event('input', { bubbles: true }));
        }
        
        hideAutocomplete();
        
        // Focar sem prevenir scroll apenas em desktop
        if (window.innerWidth > 768) {
          textarea.focus({ preventScroll: true });
        } else {
          textarea.focus();
        }
      }

      function checkForAutocomplete() {
        const cursorPos = textarea.selectionStart;
        const text = textarea.value;
        
        let variableStart = -1;
        let searchText = '';
        let isInsideVariable = false;
        
        // Primeiro: verificar se estamos dentro de {{}}
        for (let i = cursorPos - 1; i >= 1; i--) {
          if (text.substring(i - 1, i + 1) === '{{') {
            variableStart = i + 1; // Posi√ß√£o ap√≥s {{
            searchText = text.substring(i + 1, cursorPos);
            isInsideVariable = true;
            break;
          }
          // Se encontrar }} antes de {{, n√£o estamos em uma vari√°vel
          if (text.substring(i - 1, i + 1) === '}}') {
            break;
          }
        }
        
        // Se n√£o estamos dentro de {{}}, verificar se estamos digitando uma palavra
        if (!isInsideVariable) {
          // Buscar o in√≠cio da palavra atual (letras, n√∫meros, underscore)
          let wordStart = cursorPos;
          while (wordStart > 0 && /[a-zA-Z0-9_]/.test(text[wordStart - 1])) {
            wordStart--;
          }
          
          // Se temos pelo menos 2 caracteres de uma palavra
          if (cursorPos - wordStart >= 2) {
            searchText = text.substring(wordStart, cursorPos);
            variableStart = wordStart;
            isInsideVariable = false;
          }
        }
        
        // Se temos texto para buscar (dentro de {{}} ou palavra normal)
        if (searchText && (isInsideVariable || (!isInsideVariable && searchText.length >= 2))) {
          // Se estamos dentro de {{}} e h√° }}, n√£o mostrar autocomplete
          if (isInsideVariable && searchText.includes('}}')) {
            hideAutocomplete();
            return;
          }
          
          // Filtrar sugest√µes
          const allSuggestions = [
            { key: 'campanha', label: 'Nome da Campanha', insertText: isInsideVariable ? 'campanha}}' : '{{campanha}}' },
            ...state.variaveis.map(v => ({ 
              key: v.nome, 
              label: v.label,
              insertText: isInsideVariable ? v.nome + '}}' : '{{' + v.nome + '}}'
            }))
          ];
          
          const filteredSuggestions = allSuggestions.filter(suggestion => {
            const matchesKey = suggestion.key.toLowerCase().includes(searchText.toLowerCase());
            const matchesLabel = suggestion.label.toLowerCase().includes(searchText.toLowerCase());
            return matchesKey || matchesLabel;
          });
          
          if (filteredSuggestions.length > 0) {
            // Adicionar informa√ß√£o sobre o contexto
            filteredSuggestions.forEach(suggestion => {
              suggestion.isInsideVariable = isInsideVariable;
              suggestion.searchStart = variableStart;
              suggestion.searchEnd = cursorPos;
            });
            
            showAutocomplete(filteredSuggestions, cursorPos);
          } else {
            hideAutocomplete();
          }
        } else {
          hideAutocomplete();
        }
      }

      function debouncedCheckAutocomplete(immediate = false) {
        // Cancelar timer anterior se existir
        if (debounceTimer) {
          clearTimeout(debounceTimer);
        }
        
        if (immediate) {
          // Executar imediatamente
          checkForAutocomplete();
        } else {
          // Executar ap√≥s delay
          debounceTimer = setTimeout(() => {
            checkForAutocomplete();
            debounceTimer = null;
          }, 100); // Reduzindo para 100ms para melhor responsividade
        }
      }

      // Event listeners
      textarea.addEventListener('input', (e) => {
        debouncedCheckAutocomplete(false);
      });
      
      textarea.addEventListener('keydown', (e) => {
        if (!customAutocompleteActive) {
          // Se n√£o est√° ativo, verificar com debounce para todos os casos
          if (e.key.length === 1 || e.key === 'Backspace') {
            debouncedCheckAutocomplete(false);
          }
          return;
        }
        
        // Controlar navega√ß√£o no autocomplete quando est√° ativo
        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, currentSuggestions.length - 1);
            updateSelection();
            break;
          case 'ArrowUp':
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, 0);
            updateSelection();
            break;
          case 'Enter':
          case 'Tab':
            e.preventDefault();
            if (selectedIndex >= 0 && currentSuggestions[selectedIndex]) {
              selectSuggestion(currentSuggestions[selectedIndex]);
            }
            break;
          case 'Escape':
            e.preventDefault();
            hideAutocomplete();
            break;
          default:
            // Para outras teclas quando autocomplete est√° ativo, verificar contexto
            if (e.key.length === 1 || e.key === 'Backspace') {
              // Permitir que a tecla seja processada primeiro, depois verificar
              setTimeout(() => debouncedCheckAutocomplete(false), 10);
            }
        }
      });

      // Fechar ao clicar fora
      document.addEventListener('click', (e) => {
        if (!textarea.contains(e.target) && !autocompleteContainer?.contains(e.target)) {
          hideAutocomplete();
        }
      });
      
      // Fechar ao redimensionar tela (mobile orientation change)
      window.addEventListener('resize', () => {
        if (customAutocompleteActive) {
          hideAutocomplete();
        }
      });
      
      // Fechar ao fazer scroll
      window.addEventListener('scroll', () => {
        if (customAutocompleteActive) {
          hideAutocomplete();
        }
      });
      
      // Limpar debounce quando o textarea perde o foco
      textarea.addEventListener('blur', () => {
        // Pequeno delay para permitir clicks no autocomplete
        setTimeout(() => {
          if (debounceTimer) {
            clearTimeout(debounceTimer);
            debounceTimer = null;
          }
          hideAutocomplete();
        }, 200);
      });
    }

    function updateTributeValues() {
      // Fun√ß√£o mantida para compatibilidade - agora n√£o faz nada pois usamos autocomplete customizado
    }

    // ===== Live Preview e Highlighting =====
    function updateTemplatePreview() {
      const template = el('#template').value;
      const preview = el('#templatePreview');
      
      if (!template.trim()) {
        preview.innerHTML = '<div class="text-muted small text-center p-3">Digite o template acima para ver a pr√©via aqui</div>';
        return;
      }

      // Dados de exemplo para preview
      const sampleData = getSampleDataForPreview();
      
      // Renderizar template com dados de exemplo
      let rendered = renderTemplateForPreview(template, sampleData);
      
      preview.innerHTML = rendered;
    }

    function getSampleDataForPreview() {
      const sampleData = {
        campanha: el('#nomeCampanha').value || 'Minha Empresa'
      };
      
      state.variaveis.forEach(variavel => {
        switch (variavel.nome) {
          case 'nome':
            sampleData[variavel.nome] = 'Ana Souza';
            break;
          case 'telefone':
          case 'whatsapp':
          case 'celular':
          case 'phone':
            sampleData[variavel.nome] = '(11) 9 9999-9999';
            break;
          case 'produto':
            sampleData[variavel.nome] = 'Produto A';
            break;
          case 'valor':
          case 'preco':
          case 'cashback':
          case 'dinheiro':
            sampleData[variavel.nome] = 'R$ 35,50';
            break;
          case 'data':
          case 'data_entrega':
            sampleData[variavel.nome] = '15/11/2024';
            break;
          case 'email':
            sampleData[variavel.nome] = 'ana@email.com';
            break;
          default:
            // Gerar valor baseado no tipo
            if (variavel.tipo === 'number') {
              sampleData[variavel.nome] = '123';
            } else if (variavel.tipo === 'date') {
              sampleData[variavel.nome] = '15/11/2024';
            } else {
              sampleData[variavel.nome] = variavel.label || variavel.nome;
            }
        }
      });
      
      return sampleData;
    }

    function renderTemplateForPreview(template, data) {
      // Encontrar todas as vari√°veis no template
      const variablePattern = /\{\{([^}]+)\}\}/g;
      let rendered = template;
      let usedVariables = new Set();
      
      rendered = rendered.replace(variablePattern, (match, varName) => {
        const cleanVarName = varName.trim();
        usedVariables.add(cleanVarName);
        
        // Verificar se a vari√°vel existe
        const variableExists = state.variaveis.some(v => v.nome === cleanVarName) || cleanVarName === 'campanha';
        
        if (variableExists && data[cleanVarName]) {
          return `<span class="preview-variable">${data[cleanVarName]}</span>`;
        } else {
          return `<span class="preview-invalid-variable">{{${cleanVarName}}}</span>`;
        }
      });
      
      return rendered;
    }

    function setupTemplateHighlighting() {
      const templateTextarea = el('#template');
      if (!templateTextarea) return;
      
      // Criar container com overlay para highlighting
      const container = document.createElement('div');
      container.className = 'template-input-container';
      
      // Criar overlay para highlighting
      const overlay = document.createElement('div');
      overlay.className = 'template-highlight-overlay';
      overlay.id = 'templateHighlightOverlay';
      
      // Substituir textarea no DOM
      templateTextarea.parentNode.insertBefore(container, templateTextarea);
      container.appendChild(overlay);
      container.appendChild(templateTextarea);
      
      // Fun√ß√£o para atualizar highlighting
      function updateHighlighting() {
        const text = templateTextarea.value;
        const highlightedText = highlightVariablesInText(text);
        overlay.innerHTML = highlightedText;
        
        // Sincronizar scroll
        overlay.scrollTop = templateTextarea.scrollTop;
        overlay.scrollLeft = templateTextarea.scrollLeft;
      }
      
      // Event listeners para atualizar preview e highlighting
      templateTextarea.addEventListener('input', () => {
        updateHighlighting();
        updateTemplatePreview();
        // Tamb√©m salvar automaticamente
        clearTimeout(window.autoSaveTimeout);
        window.autoSaveTimeout = setTimeout(salvarDados, 1000);
      });
      
      templateTextarea.addEventListener('scroll', () => {
        overlay.scrollTop = templateTextarea.scrollTop;
        overlay.scrollLeft = templateTextarea.scrollLeft;
      });
      
      templateTextarea.addEventListener('keyup', () => {
        updateHighlighting();
        updateTemplatePreview();
      });
      
      templateTextarea.addEventListener('paste', () => {
        setTimeout(() => {
          updateHighlighting();
          updateTemplatePreview();
        }, 10);
      });
      
      // Atualizar highlighting inicial
      updateHighlighting();
    }

    function highlightVariablesInText(text) {
      if (!text) return '';
      
      // Escapar HTML primeiro
      let highlighted = text.replace(/&/g, '&amp;')
                           .replace(/</g, '&lt;')
                           .replace(/>/g, '&gt;');
      
      // Encontrar e destacar vari√°veis {{variavel}}
      const variablePattern = /\{\{([^}]+)\}\}/g;
      
      highlighted = highlighted.replace(variablePattern, (match, varName) => {
        const cleanVarName = varName.trim();
        
        // Verificar se a vari√°vel existe
        const variableExists = state.variaveis.some(v => v.nome === cleanVarName) || cleanVarName === 'campanha';
        
        if (variableExists) {
          return `<span class="highlight-variable">${match}</span>`;
        } else {
          return `<span class="highlight-invalid">${match}</span>`;
        }
      });
      
      return highlighted;
    }

    // ===== Gerenciamento de Tabela =====
    function renderizarTabela() {
      const header = el('#tableHeader');
      header.innerHTML = '';

      // Cabe√ßalhos das colunas
      state.variaveis.forEach(variavel => {
        const th = document.createElement('th');
        th.style.minWidth = '150px';
        th.innerHTML = `
          <div class="d-flex align-items-center gap-1">
            <span>${variavel.label}</span>
            ${variavel.obrigatorio ? '<i class="bi bi-asterisk text-danger small"></i>' : ''}
            ${(variavel.nome === 'telefone' || variavel.nome === 'whatsapp' || variavel.nome === 'celular' || variavel.nome === 'phone' || variavel.nome.includes('tel') || variavel.nome.includes('fone')) ? '<i class="bi bi-telephone text-info small ms-1" title="Campo com m√°scara de telefone"></i>' : ''}
          </div>
        `;
        header.appendChild(th);
      });

      // Coluna de a√ß√µes
      const actionsHeader = document.createElement('th');
      actionsHeader.style.minWidth = '120px';
      actionsHeader.innerHTML = '<i class="bi bi-gear"></i> A√ß√µes';
      header.appendChild(actionsHeader);

      // Limpar linhas existentes
      els('#tbl tbody tr').forEach(tr => tr.remove());
      
      // Aplicar m√°scaras ap√≥s renderizar
      setTimeout(() => {
        aplicarMascarasEmTodosOsTelefones();
      }, 100);
    }

    function addRow(dados = {}) {
      const tbody = el('#tbl tbody');
      const tr = document.createElement('tr');

      // Campos das vari√°veis
      state.variaveis.forEach((variavel, index) => {
        const td = document.createElement('td');
        td.setAttribute('data-label', variavel.label);
        
        const input = document.createElement('input');
        input.type = variavel.tipo;
        input.className = 'form-control form-control-sm';
        input.value = dados[variavel.nome] || '';
        input.placeholder = variavel.label;
        input.addEventListener('input', () => {
          clearTimeout(window.autoSaveTimeout);
          window.autoSaveTimeout = setTimeout(salvarDados, 1000);
        });
        
        // Aplicar m√°scara se for campo de telefone
        const isTelefone = variavel.nome === 'telefone' || 
                          variavel.nome === 'whatsapp' || 
                          variavel.nome === 'celular' || 
                          variavel.nome === 'phone' ||
                          variavel.nome.includes('tel') ||
                          variavel.nome.includes('fone');
        
        if (isTelefone) {
          configurarMascaraTelefone(input);
        }
        
        td.appendChild(input);
        tr.appendChild(td);
      });

      // Coluna de a√ß√µes
      const actionsTd = document.createElement('td');
      actionsTd.setAttribute('data-label', 'A√ß√µes');
      actionsTd.innerHTML = `
        <div class="d-flex gap-1">
          <button class="btn btn-sm btn-outline-secondary" data-act="dup" title="Duplicar">
            <i class="bi bi-copy"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger" data-act="del" title="Excluir">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      `;
      tr.appendChild(actionsTd);

      tbody.appendChild(tr);

      // Event listeners para a√ß√µes
      tr.addEventListener('click', (ev) => {
        const act = ev.target.closest('[data-act]')?.dataset?.act;
        if (!act) return;
        
        if (act === 'del') {
          tr.remove();
          salvarDados();
        }
        
        if (act === 'dup') {
          const inputs = els('input', tr);
          const dadosDuplicados = {};
          inputs.forEach((input, index) => {
            // Para campos de telefone, obter valor sem m√°scara para duplica√ß√£o
            let valor = input.value;
            const variavel = state.variaveis[index];
            const isTelefone = variavel.nome === 'telefone' || 
                              variavel.nome === 'whatsapp' || 
                              variavel.nome === 'celular' || 
                              variavel.nome === 'phone' ||
                              variavel.nome.includes('tel') ||
                              variavel.nome.includes('fone');
            
            if (isTelefone) {
              // Manter a formata√ß√£o visual para o usu√°rio
              valor = input.value;
            }
            
            dadosDuplicados[variavel.nome] = valor;
          });
          addRow(dadosDuplicados);
          salvarDados();
        }
      });
    }

    function lerTabela() {
      const rows = els('#tbl tbody tr');
      const registros = [];

      rows.forEach(tr => {
        const inputs = els('input', tr);
        const registro = {};
        let temDados = false;

        inputs.forEach((input, index) => {
          const variavel = state.variaveis[index];
          let valor = input.value.trim();
          
          // Para campos de telefone, remover formata√ß√£o para armazenamento
          const isTelefone = variavel.nome === 'telefone' || 
                            variavel.nome === 'whatsapp' || 
                            variavel.nome === 'celular' || 
                            variavel.nome === 'phone' ||
                            variavel.nome.includes('tel') ||
                            variavel.nome.includes('fone');
          
          if (isTelefone && valor) {
            // Manter apenas os d√≠gitos para armazenamento, mas preservar formata√ß√£o visual
            const apenasDigitos = valor.replace(/\D/g, '');
            // Se o n√∫mero parece ser brasileiro, armazenar com formata√ß√£o leg√≠vel
            if (apenasDigitos.length >= 10) {
              valor = input.value; // Manter formata√ß√£o visual
            }
          }
          
          registro[variavel.nome] = valor;
          if (valor) temDados = true;
        });

        if (temDados) registros.push(registro);
      });

      return registros;
    }

    // ===== Utilit√°rios =====
    function normalizarTelefone(raw) {
      if (!raw) return '';
      let digits = ('' + raw).replace(/\D/g, '');
      if (digits.length >= 3 && digits[0] === '0') digits = digits.slice(1);
      if (digits.startsWith('55')) return digits;
      if (digits.length >= 10 && digits.length <= 11) return '55' + digits;
      return digits;
    }

    // ===== M√°scaras de Telefone =====
    function aplicarMascaraTelefone(input) {
      const valor = input.value.replace(/\D/g, '');
      let masked = '';
      
      if (valor.length === 0) {
        masked = '';
      } else if (valor.length <= 2) {
        // Apenas DDD: (11
        masked = `(${valor}`;
      } else if (valor.length <= 3) {
        // DDD + primeiro d√≠gito: (11) 9
        masked = `(${valor.slice(0, 2)}) ${valor.slice(2)}`;
      } else if (valor.length <= 7) {
        // DDD + primeiros d√≠gitos: (11) 9 9999
        masked = `(${valor.slice(0, 2)}) ${valor.slice(2, 3)} ${valor.slice(3)}`;
      } else if (valor.length <= 11) {
        // Celular completo: (11) 9 9999-9999
        masked = `(${valor.slice(0, 2)}) ${valor.slice(2, 3)} ${valor.slice(3, 7)}-${valor.slice(7)}`;
      } else {
        // Telefone internacional: +55 (11) 9 9999-9999
        if (valor.startsWith('55') && valor.length <= 13) {
          const ddd = valor.slice(2, 4);
          const nono = valor.slice(4, 5);
          const primeira = valor.slice(5, 9);
          const segunda = valor.slice(9, 13);
          masked = `+55 (${ddd}) ${nono} ${primeira}${segunda ? '-' + segunda : ''}`;
        } else {
          // Fallback para n√∫meros muito longos
          masked = `+${valor.slice(0, 2)} (${valor.slice(2, 4)}) ${valor.slice(4, 5)} ${valor.slice(5, 9)}-${valor.slice(9, 13)}`;
        }
      }
      
      input.value = masked;
    }

    function configurarMascaraTelefone(input) {
      // Adicionar classe para estiliza√ß√£o
      input.classList.add('phone-input');
      
      // Atualizar placeholder
      if (input.placeholder.toLowerCase().includes('telefone') || 
          input.placeholder.toLowerCase().includes('whatsapp') ||
          input.placeholder.toLowerCase().includes('celular') ||
          input.placeholder.toLowerCase().includes('phone')) {
        input.placeholder = 'Ex: (11) 9 9999-9999';
      }
      
      // Event listeners
      input.addEventListener('input', (e) => {
        const cursorPos = e.target.selectionStart;
        const oldLength = e.target.value.length;
        
        aplicarMascaraTelefone(e.target);
        
        // Ajustar posi√ß√£o do cursor ap√≥s aplicar m√°scara
        const newLength = e.target.value.length;
        const diff = newLength - oldLength;
        
        // Manter cursor na posi√ß√£o adequada
        let newPos = cursorPos + diff;
        if (newPos < 0) newPos = 0;
        if (newPos > newLength) newPos = newLength;
        
        // Evitar cursor em posi√ß√µes de formata√ß√£o
        const formatChars = ['(', ')', ' ', '-', '+'];
        if (formatChars.includes(e.target.value[newPos - 1]) && diff > 0) {
          newPos++;
        }
        
        setTimeout(() => {
          e.target.setSelectionRange(newPos, newPos);
        }, 0);
        
        // Trigger auto-save se existir
        if (window.autoSaveTimeout) {
          clearTimeout(window.autoSaveTimeout);
          window.autoSaveTimeout = setTimeout(salvarDados, 1000);
        }
      });
      
      // Aplicar m√°scara no valor inicial se existir
      if (input.value) {
        aplicarMascaraTelefone(input);
      }
    }

    function aplicarMascarasEmTodosOsTelefones() {
      // Aplicar em inputs existentes na tabela
      const phoneInputs = els('#tbl input').filter(input => {
        const variavel = state.variaveis.find((v, index) => {
          const cell = input.closest('td');
          const cellIndex = Array.from(cell.parentNode.children).indexOf(cell);
          return cellIndex === index && (
            v.nome === 'telefone' || 
            v.nome === 'whatsapp' || 
            v.nome === 'celular' || 
            v.nome === 'phone' ||
            v.nome.includes('tel') ||
            v.nome.includes('fone')
          );
        });
        return variavel;
      });
      
      phoneInputs.forEach(configurarMascaraTelefone);
    }

    function formatBRL(v) {
      const n = Number(v || 0);
      return n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function primeiroNome(nome) {
      if (!nome) return '';
      return ('' + nome).trim().split(/\s+/)[0];
    }

    function renderTemplate(tpl, ctx) {
      let out = tpl;
      // Substituir vari√°veis
      out = out.replace(/\{\{(.*?)\}\}/g, (_, key) => {
        const k = key.trim();
        let valor = ctx[k] ?? '';
        
        // Formata√ß√£o especial para valores monet√°rios
        if (k.includes('valor') || k.includes('preco') || k.includes('cashback') || k.includes('dinheiro')) {
          if (valor && !isNaN(valor)) {
            valor = formatBRL(valor);
          }
        }
        
        return valor;
      });
      return out;
    }

    function setDefaultTemplate() {
      const tpl = `Ol√° {{nome}}! üëã

Esta √© uma mensagem personalizada da {{campanha}}.

Para mais informa√ß√µes, entre em contato conosco pelo WhatsApp!`;
      el('#template').value = tpl;
    }

    // ===== Gera√ß√£o de Mensagens =====
    function gerar() {
      const nomeCampanha = el('#nomeCampanha').value.trim();
      const campoTelefone = el('#campoTelefone').value;
      const tpl = el('#template').value.trim();
      const registros = lerTabela();
      const lista = el('#lista');
      
      lista.innerHTML = '';

      if (!tpl) {
        alert('Defina um template de mensagem.');
        return;
      }

      if (registros.length === 0) {
        alert('Adicione pelo menos um registro.');
        return;
      }

      registros.forEach((registro, idx) => {
        const telIntl = normalizarTelefone(registro[campoTelefone]);
        
        const ctx = {
          ...registro,
          campanha: nomeCampanha,
          primeiro_nome: primeiroNome(registro.nome || ''),
          telefone: telIntl
        };

        const msg = renderTemplate(tpl, ctx);
        const qs = new URLSearchParams({ text: msg.normalize('NFC') }).toString();
        const url = `https://wa.me/${telIntl}?${qs}`;

        const item = document.createElement('div');
        item.className = 'message-item';
        
        // Mostrar principais vari√°veis
        const varInfo = state.variaveis
          .filter(v => v.nome !== campoTelefone)
          .slice(0, 3)
          .map(v => `${v.label}: <strong>${registro[v.nome] || '-'}</strong>`)
          .join(' ‚Ä¢ ');

        item.innerHTML = `
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="flex-grow-1">
              <h6 class="mb-1">${registro.nome || registro[state.variaveis[0]?.nome] || 'Registro #' + (idx + 1)}</h6>
              <div class="small text-muted">
                ${telIntl ? 
                  `<i class="bi bi-telephone text-success"></i> +${telIntl}` : 
                  '<i class="bi bi-exclamation-triangle text-danger"></i> Telefone inv√°lido'
                }
              </div>
            </div>
            <div class="d-flex gap-2">
              <a class="btn btn-success btn-sm" target="_blank" rel="noopener" href="${url}">
                <i class="bi bi-whatsapp me-1"></i>WhatsApp
              </a>
              <button class="btn btn-outline-secondary btn-sm copy-msg" data-idx="${idx}">
                <i class="bi bi-clipboard me-1"></i>Copiar
              </button>
            </div>
          </div>
          <div class="small text-muted mb-2">${varInfo}</div>
          <div class="preview small">${msg.replace(/</g, '&lt;')}</div>
        `;
        
        item.dataset.text = msg;
        lista.appendChild(item);
      });
    }

    // ===== Import JSON/CSV =====
    function importarJSON(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          
          // Verificar se √© um array de objetos (dados diretos)
          if (Array.isArray(data)) {
            processarDadosImportados(data);
            return;
          }
          
          // Verificar se tem dados de configura√ß√£o completa
          if (data.variaveis && data.registros) {
            const confirmar = confirm('Este arquivo cont√©m configura√ß√µes completas. Deseja substituir suas configura√ß√µes atuais?');
            if (confirmar) {
              state.variaveis = data.variaveis;
              el('#nomeCampanha').value = data.nomeCampanha || '';
              el('#campoTelefone').value = data.campoTelefone || 'telefone';
              el('#template').value = data.template || '';
              
              renderizarVariaveis();
              renderizarTabela();
              atualizarVariaveisDisponiveis();
              
              els('#tbl tbody tr').forEach(tr => tr.remove());
              data.registros.forEach(addRow);
            }
            return;
          }
          
          // Se for um objeto, tentar extrair dados
          if (typeof data === 'object') {
            // Converter objeto em array
            const arrayData = Object.keys(data).map(key => ({
              nome: key,
              ...data[key]
            }));
            processarDadosImportados(arrayData);
            return;
          }
          
          alert('Formato de arquivo JSON n√£o reconhecido.');
          
        } catch (e) {
          alert('Erro ao ler arquivo JSON. Verifique se o formato est√° correto.');
        }
      };
      reader.readAsText(file, 'utf-8');
    }

    function processarDadosImportados(dados) {
      if (!Array.isArray(dados) || dados.length === 0) {
        alert('Nenhum dado v√°lido encontrado no arquivo.');
        return;
      }
      
      // Extrair colunas do primeiro objeto
      const primeiroItem = dados[0];
      const colunas = Object.keys(primeiroItem);
      
      // Verificar se precisa adicionar novas vari√°veis
      const novasVariaveis = colunas.filter(col => 
        !state.variaveis.find(v => v.nome === col.toLowerCase())
      );

      if (novasVariaveis.length > 0) {
        const adicionar = confirm(
          `Detectadas novas vari√°veis: ${novasVariaveis.join(', ')}. Deseja adicion√°-las?`
        );
        
        if (adicionar) {
          novasVariaveis.forEach(nomeVar => {
            // Tentar detectar o tipo baseado no valor
            const valorExemplo = primeiroItem[nomeVar];
            let tipo = 'text';
            
            if (!isNaN(valorExemplo) && valorExemplo !== '') {
              tipo = 'number';
            } else if (valorExemplo && typeof valorExemplo === 'string' && valorExemplo.match(/^\d{4}-\d{2}-\d{2}$/)) {
              tipo = 'date';
            }
            
            state.variaveis.push({
              nome: nomeVar.toLowerCase(),
              label: nomeVar,
              tipo: tipo,
              obrigatorio: false
            });
          });
          
          renderizarVariaveis();
          renderizarTabela();
          atualizarVariaveisDisponiveis();
        }
      }

      // Importar dados
      dados.forEach(item => {
        const dadosLinha = {};
        colunas.forEach(coluna => {
          dadosLinha[coluna.toLowerCase()] = item[coluna] || '';
        });
        addRow(dadosLinha);
      });

      salvarDados();
      alert(`${dados.length} registros importados com sucesso!`);
    }
    function importarCSV(file) {
      const reader = new FileReader();
      reader.onload = () => {
        const text = reader.result;
        const linhas = ('' + text).split(/\r?\n/).filter(l => l.trim().length);
        
        if (linhas.length === 0) return;

        // Primeira linha como cabe√ßalho
        const cabecalho = linhas[0].split(',').map(h => h.trim());
        
        // Verificar se precisa ajustar vari√°veis
        const novasVariaveis = cabecalho.filter(h => 
          !state.variaveis.find(v => v.nome === h.toLowerCase())
        );

        if (novasVariaveis.length > 0) {
          const adicionar = confirm(
            `Detectadas novas vari√°veis: ${novasVariaveis.join(', ')}. Deseja adicion√°-las?`
          );
          
          if (adicionar) {
            novasVariaveis.forEach(nomeVar => {
              state.variaveis.push({
                nome: nomeVar.toLowerCase(),
                label: nomeVar,
                tipo: 'text',
                obrigatorio: false
              });
            });
            renderizarVariaveis();
            renderizarTabela();
            atualizarVariaveisDisponiveis();
          }
        }

        // Importar dados
        for (let i = 1; i < linhas.length; i++) {
          const valores = linhas[i].split(',').map(v => v.trim());
          const dadosLinha = {};
          
          cabecalho.forEach((coluna, index) => {
            dadosLinha[coluna.toLowerCase()] = valores[index] || '';
          });
          
          addRow(dadosLinha);
        }

        salvarDados();
      };
      reader.readAsText(file, 'utf-8');
    }

    function carregarExemplo() {
      // Limpar tabela
      els('#tbl tbody tr').forEach(tr => tr.remove());
      
      // Configurar vari√°veis exemplo
      state.variaveis = [
        { nome: 'nome', label: 'Nome completo', tipo: 'text', obrigatorio: true },
        { nome: 'telefone', label: 'Telefone', tipo: 'text', obrigatorio: true },
        { nome: 'produto', label: 'Produto', tipo: 'text', obrigatorio: false },
        { nome: 'valor', label: 'Valor', tipo: 'number', obrigatorio: false }
      ];

      renderizarVariaveis();
      renderizarTabela();
      atualizarVariaveisDisponiveis();

      // Dados exemplo
      const exemplos = [
        { nome: 'Ana Souza', telefone: '(92) 9 8888-1111', produto: 'Produto A', valor: 35.50 },
        { nome: 'Bruno Lima', telefone: '92 99999-2222', produto: 'Produto B', valor: 120 },
        { nome: 'Carla Mendes', telefone: '(11) 9 7654-3333', produto: 'Produto C', valor: 80.90 }
      ];

      exemplos.forEach(addRow);

      // Template exemplo
      el('#template').value = `Ol√° {{nome}}! üëã

Seu pedido do {{produto}} no valor de {{valor}} foi processado com sucesso!

Entre em contato pelo WhatsApp para mais detalhes.`;

      el('#nomeCampanha').value = 'Minha Loja Online';

      salvarDados();
      
      // Atualizar preview ap√≥s carregar exemplo
      setTimeout(updateTemplatePreview, 100);
    }

    // ===== Fun√ß√µes Utilit√°rias =====
    function mostrarAlerta(titulo, mensagem, tipo = 'info') {
      // Criar toast para feedback
      const toastContainer = el('#toastContainer') || (() => {
        const container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '1100';
        document.body.appendChild(container);
        return container;
      })();

      const toast = document.createElement('div');
      toast.className = 'toast align-items-center text-bg-' + tipo + ' border-0';
      toast.setAttribute('role', 'alert');
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">
            <strong>${titulo}:</strong> ${mensagem}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      
      toastContainer.appendChild(toast);
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();
      
      toast.addEventListener('hidden.bs.toast', () => toast.remove());
    }

    function mostrarModalConfirmacao(titulo, mensagem, callback) {
      el('#modalConfirmarTitulo').textContent = titulo;
      el('#modalConfirmarTexto').innerHTML = `<p>${mensagem}</p>`;
      
      const btnConfirmar = el('#btnConfirmarAcao');
      btnConfirmar.textContent = 'Confirmar';
      btnConfirmar.className = 'btn btn-danger';
      
      const modal = new bootstrap.Modal(el('#modalConfirmar'));
      modal.show();
      
      btnConfirmar.onclick = () => {
        modal.hide();
        callback();
      };
    }

    function mostrarModalInput(titulo, mensagem, callback) {
      el('#modalConfirmarTitulo').textContent = titulo;
      el('#modalConfirmarTexto').innerHTML = `
        <p>${mensagem}</p>
        <input type="text" class="form-control" id="inputTempModal" placeholder="Digite aqui...">
      `;
      
      const btnConfirmar = el('#btnConfirmarAcao');
      btnConfirmar.textContent = 'Salvar';
      btnConfirmar.className = 'btn btn-primary';
      
      const modal = new bootstrap.Modal(el('#modalConfirmar'));
      modal.show();
      
      // Focar no input quando modal abrir
      el('#modalConfirmar').addEventListener('shown.bs.modal', () => {
        el('#inputTempModal').focus();
      }, { once: true });
      
      // Configurar callback
      btnConfirmar.onclick = () => {
        const valor = el('#inputTempModal').value;
        modal.hide();
        callback(valor);
      };
    }

    // ===== Gerenciamento de Clientes =====
    function salvarListaClientes() {
      const registros = lerTabela();
      if (registros.length === 0) {
        mostrarAlerta('Aviso', 'N√£o h√° registros para salvar. Adicione alguns dados primeiro.', 'warning');
        return;
      }

      mostrarModalInput('Salvar Lista de Registros', 'Digite um nome para esta lista de dados:', (nome) => {
        if (!nome.trim()) return;
        
        const listas = JSON.parse(localStorage.getItem('message-generator-clientes') || '{}');
        listas[nome.trim()] = {
          registros: registros,
          variaveis: state.variaveis,
          timestamp: new Date().toISOString()
        };
        
        localStorage.setItem('message-generator-clientes', JSON.stringify(listas));
        atualizarListaClientesSalvos();
        mostrarAlerta('Sucesso', `Lista de registros "${nome.trim()}" salva com sucesso!`, 'success');
      });
    }

    function atualizarListaClientesSalvos() {
      const listas = JSON.parse(localStorage.getItem('message-generator-clientes') || '{}');
      const container = el('#listaClientesSalvos');
      container.innerHTML = '';

      const nomes = Object.keys(listas).sort();
      if (nomes.length === 0) {
        container.innerHTML = '<div class="text-center text-muted p-3"><i class="bi bi-inbox"></i><br>Nenhuma lista de registros salva ainda</div>';
        return;
      }

      nomes.forEach(nome => {
        const lista = listas[nome];
        const div = document.createElement('div');
        div.className = 'border rounded p-3 mb-2';
        div.style.background = 'var(--input-bg)';
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="mb-1"><i class="bi bi-table me-1"></i>${nome}</h6>
              <small class="text-muted">
                <i class="bi bi-person me-1"></i>${lista.registros.length} registros ‚Ä¢ 
                <i class="bi bi-tags me-1"></i>${lista.variaveis.length} vari√°veis ‚Ä¢ 
                ${new Date(lista.timestamp).toLocaleDateString('pt-BR')}
              </small>
            </div>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="carregarListaClientes('${nome}')" title="Carregar esta lista">
                <i class="bi bi-arrow-down-circle"></i>
              </button>
              <button class="btn btn-outline-danger" onclick="excluirListaClientes('${nome}')" title="Excluir lista">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function carregarListaClientes(nome) {
      const listas = JSON.parse(localStorage.getItem('message-generator-clientes') || '{}');
      const lista = listas[nome];
      
      if (!lista) {
        mostrarAlerta('Erro', 'Lista de registros n√£o encontrada.', 'danger');
        return;
      }

      // Limpar tabela atual
      els('#tbl tbody tr').forEach(tr => tr.remove());
      
      // Carregar vari√°veis da lista
      state.variaveis = lista.variaveis;
      renderizarVariaveis();
      renderizarTabela();
      
      // Carregar registros
      lista.registros.forEach(addRow);
      
      atualizarVariaveisDisponiveis();
      salvarDados();
      
      // Fechar modal
      bootstrap.Modal.getInstance(el('#modalGerenciarDados')).hide();
      
      mostrarAlerta('Sucesso', `Lista de registros "${nome}" carregada com sucesso!`, 'success');
    }

    function excluirListaClientes(nome) {
      mostrarModalConfirmacao('Excluir Lista de Registros', `Tem certeza que deseja excluir a lista "${nome}"?`, () => {
        const listas = JSON.parse(localStorage.getItem('message-generator-clientes') || '{}');
        delete listas[nome];
        localStorage.setItem('message-generator-clientes', JSON.stringify(listas));
        atualizarListaClientesSalvos();
        mostrarAlerta('Sucesso', `Lista de registros "${nome}" exclu√≠da com sucesso!`, 'success');
      });
    }

    function resetarDados() {
      mostrarModalConfirmacao('Resetar Todos os Dados', 
        'Esta a√ß√£o ir√° remover TODOS os dados salvos (configura√ß√µes, listas de clientes, auto-save). Deseja continuar?', 
        () => {
          localStorage.removeItem(STORAGE_KEY);
          localStorage.removeItem(AUTOSAVE_KEY);
          localStorage.removeItem('message-generator-clientes');
          localStorage.removeItem('app-theme');
          
          // Resetar para estado inicial
          state.variaveis = [
            { nome: 'nome', label: 'Nome completo', tipo: 'text', obrigatorio: true },
            { nome: 'telefone', label: 'Telefone', tipo: 'text', obrigatorio: true }
          ];
          state.registros = [];
          
          el('#nomeCampanha').value = '';
          el('#campoTelefone').value = 'telefone';
          el('#template').value = '';
          
          els('#tbl tbody tr').forEach(tr => tr.remove());
          el('#lista').innerHTML = '';
          
          renderizarVariaveis();
          renderizarTabela();
          addRow({});
          atualizarVariaveisDisponiveis();
          atualizarListaConfiguracoes();
          atualizarListaClientesSalvos();
          
          // Reinicializar tema
          initTheme();
          
          mostrarAlerta('Sucesso', 'Todos os dados foram resetados!', 'success');
        }
      );
    }

    function confirmarSalvarConfiguracao() {
      const nome = el('#nomeConfig').value.trim();
      if (!nome) {
        mostrarAlerta('Erro', 'Por favor, digite um nome para a configura√ß√£o.', 'danger');
        return;
      }

      salvarDados(nome);
      el('#formSalvarConfig').reset();
      bootstrap.Modal.getInstance(el('#modalSalvarConfig')).hide();
    }

    // ===== Event Listeners =====
    document.addEventListener('click', (ev) => {
      if (ev.target.id === 'themeToggle' || ev.target.closest('#themeToggle')) {
        toggleTheme();
      }
      if (ev.target.id === 'btnAdicionarVariavel') adicionarVariavel();
      if (ev.target.id === 'btnConfirmarVariavel') confirmarAdicionarVariavel();
      if (ev.target.id === 'btnConfirmarSalvarConfig') confirmarSalvarConfiguracao();
      if (ev.target.id === 'btnSalvarClientes') salvarListaClientes();
      if (ev.target.id === 'btnNovaLinha') addRow({});
      if (ev.target.id === 'btnGerar') gerar();
      if (ev.target.id === 'btnCarregarExemplo') carregarExemplo();
      if (ev.target.id === 'btnLimpar') {
        mostrarModalConfirmacao('Limpar Registros', 'Tem certeza que deseja limpar todos os registros da tabela? Esta a√ß√£o n√£o pode ser desfeita.', () => {
          els('#tbl tbody tr').forEach(tr => tr.remove());
          el('#lista').innerHTML = '';
          addRow({});
          salvarDados();
          mostrarAlerta('Sucesso', 'Registros limpos com sucesso!', 'success');
        });
      }
      if (ev.target.classList.contains('copy-msg')) {
        const idx = Number(ev.target.dataset.idx);
        const text = el('#lista').children[idx]?.dataset?.text || '';
        if (!text) {
          mostrarAlerta('Aviso', 'Nada para copiar.', 'warning');
          return;
        }
        navigator.clipboard.writeText(text).then(() => {
          const icon = ev.target.querySelector('i');
          const originalClass = icon.className;
          icon.className = 'bi bi-check me-1';
          ev.target.classList.add('btn-success');
          ev.target.classList.remove('btn-outline-secondary');
          
          setTimeout(() => {
            icon.className = originalClass;
            ev.target.classList.remove('btn-success');
            ev.target.classList.add('btn-outline-secondary');
          }, 1200);
          
          mostrarAlerta('Sucesso', 'Mensagem copiada!', 'success');
        });
      }
    });

    // Event listeners para importa√ß√£o
    el('#csv').addEventListener('change', (ev) => {
      const file = ev.target.files?.[0];
      if (file) importarCSV(file);
      ev.target.value = '';
    });

    el('#jsonImport').addEventListener('change', (ev) => {
      const file = ev.target.files?.[0];
      if (file) importarJSON(file);
      ev.target.value = '';
    });

    el('#backupFile').addEventListener('change', (ev) => {
      const file = ev.target.files?.[0];
      if (file) importarDados(file);
      ev.target.value = '';
    });

    el('#importarTudo').addEventListener('change', (ev) => {
      const file = ev.target.files?.[0];
      if (file) importarDados(file);
      ev.target.value = '';
    });

    // Auto-save setup
    function setupAutoSave() {
      const inputs = ['#nomeCampanha', '#campoTelefone', '#template'];
      inputs.forEach(sel => {
        el(sel).addEventListener('input', () => {
          clearTimeout(window.autoSaveTimeout);
          window.autoSaveTimeout = setTimeout(salvarDados, 1000);
        });
      });
    }

    // ===== Inicializa√ß√£o =====
    function inicializar() {
      initTheme();
      initConfigDropdown();
      renderizarVariaveis();
      renderizarTabela();
      atualizarVariaveisDisponiveis();
      // Inicializar autocomplete de vari√°veis
      initVariableAutocomplete();
      // Configurar highlighting e preview do template
      setupTemplateHighlighting();
      setupAutoSave();
      atualizarListaConfiguracoes();
      atualizarListaClientesSalvos();
      atualizarListaConfigsModal();
      
      // Carregar auto-save se existir
      const autosaveData = localStorage.getItem(AUTOSAVE_KEY);
      if (autosaveData) {
        carregarDados();
      } else {
        setDefaultTemplate();
        addRow({});
      }
      
      // Aplicar m√°scaras de telefone ap√≥s tudo carregar
      setTimeout(() => {
        aplicarMascarasEmTodosOsTelefones();
        // Atualizar preview inicial
        updateTemplatePreview();
      }, 200);
    }

    // Inicializar quando p√°gina carregar
    document.addEventListener('DOMContentLoaded', inicializar);
  </script>
</body>
</html>